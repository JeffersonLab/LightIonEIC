#! /usr/bin/perl
#  programmed by kijun April.09,2004
#
print "\n  --------------------------------------------------\n";
print "  --------------------------------------------------\n";
print "                 DATA  SELECTION  PROGRAM            \n";
print "  --------------------------------------------------\n";

$channel = "enx";
  

system("rm -f gnte1fpass1\.$channel\.list");
# system("ls gnt10/nt\_$channel\_9*.hbook > gnte1fpass1\.$channel\.list");
system("ls ednt10/nt10\_coll\.$channel\_*.hbook > gnte1fpass1\.$channel\.list");

open (rfile,"gnte1fpass1\.$channel\.list");
@arr0 = <rfile>;
close(rfile);

system("rm -f Rdata_group-*");

$numfiles=$#arr0+1;
$ngroup=$numfiles/20;
for($g=0;$g<$ngroup;$g++){
    open(fil,">Rdata_group-$g");
    $start = 20*($g);
    $end = 20*($g)+19;
    for ($i=$start;$i<=$end;$i++){
	chop($arr0[$i]);
	printf fil ("$arr0[$i] ");
#	print "$com[1] ";
    }
}

print "\n  --------------------------------------------------\n";
print "  --------------------------------------------------\n";
print "         KUMAC CREATING   PROGRAM   for  $channel           \n";
print "  --------------------------------------------------\n";

system("rm -f ndata\.$channel\.list");
system("ls Rdata* > ndata\.$channel\.list");

open (list,"ndata\.$channel\.list");
@line = <list>;
close(list);

$maxline = ($#line)/30.; 

open (rfile,"sample00.kumac");
@arr0 = <rfile>;
close(rfile);

open (rfile1,"sample01.kumac");
@arr1 = <rfile1>;
close(rfile1);


    system("rm -f ntread_*\.$channel\.kumac");

for($case=0;$case<=int($maxline);$case++){
    print "$case \n";
$init=0+30*$case;
$incr=29+30*$case;
#$incr=5+30*$case;

    open(file_handle,">>ntread\_$case\.$channel\.kumac");

    print file_handle @arr0;

    for($g=$init;$g<=$incr;$g++){
        $num = 35+(35*($g-30*$case));
        $index=$g+1-30*$case;
        $index1=$g+2-(30*$case);

        open (data,"Rdata_group-$g");
        @in = <data>;
        close(data);

print file_handle <<END_OF_FILE1;
exe krun_files @in\[i$index] [2] [3] [s] [1] 
mess End of first group.Total of [@] files are processed.
i$index1 = [@]
if [2] + [4] <= $num then
    if [2] <> 0 GOTO ENDPROC
endif
if [4] <= $num then
s = 1
else
s = [4] - $num
endif 
mess i$index1 = [i$index1]
mess 2 = [2]
mess 4 = [4]

END_OF_FILE1


    }
    print file_handle @arr1;

    close(file_handle);

system("ls -al ntread\_$case\.$channel\.kumac");
}

